# Phase 3: AWS-Hybridæ§‹æˆä½“é¨“

## æ¦‚è¦

ã“ã®æ®µéšã§ã¯ã€**Strapiå°‚ç”¨AWSæ§‹æˆ**ã‚’ä½“é¨“ã—ã¾ã™ã€‚Strapiã‚’AWSä¸Šã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€Webã‚¢ãƒ—ãƒªã¯ãƒ­ãƒ¼ã‚«ãƒ«ã¾ãŸã¯Vercelã§å‹•ä½œã•ã›ã‚‹ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ§‹æˆã§ã™ã€‚

## ğŸ¯ å­¦ç¿’ç›®æ¨™

- **ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ§‹æˆã®è¤‡é›‘ã•**ã‚’å®Ÿæ„Ÿã™ã‚‹
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ–­**ã«ã‚ˆã‚‹èª²é¡Œã‚’ä½“é¨“ã™ã‚‹
- **AWSåŸºæœ¬ã‚µãƒ¼ãƒ“ã‚¹**ã®é€£æºã‚’ç†è§£ã™ã‚‹
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š**ã®é‡è¦æ€§ã‚’å®Ÿæ„Ÿã™ã‚‹

## ğŸ“‹ ä½“é¨“ã™ã¹ãè¦³ç‚¹

### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ™‚ã®èª²é¡Œ
- [ ] VPCãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šã®è¤‡é›‘ã•
- [ ] CORSè¨­å®šã®å¿…è¦æ€§
- [ ] SSLè¨¼æ˜æ›¸ã®è¨­å®š
- [ ] ç’°å¢ƒå¤‰æ•°ã®ç®¡ç†

### é‹ç”¨æ™‚ã®èª²é¡Œ
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«â‡”AWSé–“ã®é€šä¿¡é…å»¶
- [ ] ãƒ‡ãƒãƒƒã‚°ã®å›°é›£ã•ï¼ˆãƒ­ã‚°ãŒåˆ†æ•£ï¼‰
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ã®è¤‡é›‘åŒ–
- [ ] ç’°å¢ƒå·®ç•°ã«ã‚ˆã‚‹å‹•ä½œä¸å…·åˆ

### ã‚³ã‚¹ãƒˆãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- [ ] AWSæ–™é‡‘ã®ç™ºç”Ÿãƒ‘ã‚¿ãƒ¼ãƒ³
- [ ] å…¬é–‹ç¯„å›²ã®è¨­å®šãƒŸã‚¹
- [ ] IAMæ¨©é™ã®é©åˆ‡ãªè¨­å®š
- [ ] ãƒ‡ãƒ¼ã‚¿è»¢é€æ–™é‡‘ã®ç™ºç”Ÿ

## ğŸš€ å®Ÿè·µæ‰‹é †

### 1. å‰ææ¡ä»¶ç¢ºèª

```bash
# AWS CLIè¨­å®šç¢ºèª
aws sts get-caller-identity

# Terraformç¢ºèª
terraform version

# å¿…è¦ãªæ¨©é™ç¢ºèª
aws iam get-user
```

### 2. AWS-Hybridç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤

```bash
cd infrastructure/aws-hybrid

# TerraformåˆæœŸåŒ–
terraform init

# ãƒ—ãƒ©ãƒ³ç¢ºèªï¼ˆé‡è¦ï¼šã‚³ã‚¹ãƒˆã‚’äº‹å‰ç¢ºèªï¼‰
terraform plan

# ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
terraform apply
```

### 3. Strapiè¨­å®šç¢ºèª

```bash
# ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®URLå–å¾—
STRAPI_URL=$(terraform output -raw strapi_url)
echo "Strapi URL: $STRAPI_URL"

# Strapiç®¡ç†ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹
open $STRAPI_URL/admin
```

### 4. ãƒ­ãƒ¼ã‚«ãƒ«Webã‚¢ãƒ—ãƒªè¨­å®š

```bash
cd ../../applications/web-app

# ç’°å¢ƒå¤‰æ•°è¨­å®š
cat > .env.local << EOF
# AWS Strapi API
NEXT_PUBLIC_STRAPI_URL=$STRAPI_URL
STRAPI_API_TOKEN=your-strapi-api-token

# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
DATABASE_URL=file:./prisma/dev.db

# NextAuthè¨­å®š
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-here
EOF

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run dev
```

### 5. çµ±åˆãƒ†ã‚¹ãƒˆ

```bash
# Strapi APIãƒ†ã‚¹ãƒˆ
curl $STRAPI_URL/api/health

# Webã‚¢ãƒ—ãƒªã‹ã‚‰APIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ
open http://localhost:3000
```

## ğŸ” ä½“é¨“ã™ã¹ãã€Œå›°ã£ãŸã“ã¨ã€

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£
1. **CORSè¨­å®šã§è©°ã¾ã‚‹**
   - ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰AWS APIã‚’å‘¼ã³å‡ºã›ãªã„
   - ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§CORSã‚¨ãƒ©ãƒ¼

2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šãƒŸã‚¹**
   - ãƒãƒ¼ãƒˆãŒé–‹ã„ã¦ã„ãªã„
   - IPåˆ¶é™ãŒå³ã—ã™ãã‚‹

3. **SSLè¨¼æ˜æ›¸ã®å•é¡Œ**
   - HTTPSã§ãªã„ã¨APIãŒå‘¼ã¹ãªã„
   - è¨¼æ˜æ›¸ã®è‡ªå‹•æ›´æ–°è¨­å®š

### é–‹ç™ºãƒ»ãƒ‡ãƒãƒƒã‚°é–¢é€£
4. **ç’°å¢ƒå·®ç•°ã«ã‚ˆã‚‹å‹•ä½œä¸å…·åˆ**
   - ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ããŒAWSã§å‹•ã‹ãªã„
   - ç’°å¢ƒå¤‰æ•°ã®è¨­å®šãƒŸã‚¹

5. **ãƒ­ã‚°ç¢ºèªã®å›°é›£ã•**
   - CloudWatchã§ãƒ­ã‚°ã‚’è¦‹ã‚‹æ‰‹é–“
   - ã‚¨ãƒ©ãƒ¼ã®åŸå› ç‰¹å®šãŒå›°é›£

6. **ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“ã®é•·ã•**
   - ECSã‚¿ã‚¹ã‚¯ã®èµ·å‹•ã«æ™‚é–“ãŒã‹ã‹ã‚‹
   - è¨­å®šå¤‰æ›´ã®ãŸã³ã«å†ãƒ‡ãƒ—ãƒ­ã‚¤

### ã‚³ã‚¹ãƒˆé–¢é€£
7. **äºˆæƒ³å¤–ã®èª²é‡‘**
   - RDSã®æœ€ä½æ–™é‡‘
   - ãƒ‡ãƒ¼ã‚¿è»¢é€æ–™é‡‘
   - ECSã®å®Ÿè¡Œæ™‚é–“èª²é‡‘

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ã‚³ã‚¹ãƒˆæ¸¬å®š

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“æ¸¬å®š
```bash
# ãƒ­ãƒ¼ã‚«ãƒ«â†’AWS APIå‘¼ã³å‡ºã—æ™‚é–“
time curl $STRAPI_URL/api/health

# è¤‡æ•°å›å®Ÿè¡Œã—ã¦å¹³å‡ã‚’å–ã‚‹
for i in {1..10}; do
  time curl -s $STRAPI_URL/api/health > /dev/null
done
```

### ã‚³ã‚¹ãƒˆç¢ºèª
```bash
# AWS Cost Explorerç¢ºèª
aws ce get-cost-and-usage \
  --time-period Start=2024-01-01,End=2024-01-31 \
  --granularity MONTHLY \
  --metrics BlendedCost
```

## ğŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

1. **ECSã‚¿ã‚¹ã‚¯ãŒèµ·å‹•ã—ãªã„**
   ```bash
   # ã‚¿ã‚¹ã‚¯å®šç¾©ç¢ºèª
   aws ecs describe-task-definition --task-definition strapi-task
   
   # ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
   aws ecs describe-services --cluster strapi-cluster --services strapi-service
   ```

2. **RDSæ¥ç¶šã‚¨ãƒ©ãƒ¼**
   ```bash
   # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ç¢ºèª
   aws ec2 describe-security-groups --group-ids sg-xxxxxxxxx
   
   # RDSçŠ¶æ…‹ç¢ºèª
   aws rds describe-db-instances --db-instance-identifier strapi-db
   ```

3. **S3ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚¨ãƒ©ãƒ¼**
   ```bash
   # ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ç¢ºèª
   aws s3api get-bucket-policy --bucket strapi-assets-bucket
   
   # IAMãƒ­ãƒ¼ãƒ«ç¢ºèª
   aws iam get-role --role-name strapi-execution-role
   ```

## ğŸ“ å­¦ç¿’è¨˜éŒ²ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

### ä½“é¨“ã—ãŸå›°é›£
- **æœ€ã‚‚æ™‚é–“ãŒã‹ã‹ã£ãŸä½œæ¥­**: 
- **æœ€ã‚‚ç†è§£ãŒå›°é›£ã ã£ãŸæ¦‚å¿µ**: 
- **äºˆæƒ³å¤–ã ã£ãŸå•é¡Œ**: 

### ã‚³ã‚¹ãƒˆæ„Ÿè¦š
- **1æ—¥ã®é‹ç”¨ã‚³ã‚¹ãƒˆ**: $
- **æœ€ã‚‚ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹ã‚µãƒ¼ãƒ“ã‚¹**: 
- **ã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ã‚¢ã‚¤ãƒ‡ã‚¢**: 

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»é‹ç”¨
- **è¨­å®šãƒŸã‚¹ã—ã‚„ã™ã„ãƒã‚¤ãƒ³ãƒˆ**: 
- **ç›£è¦–ã™ã¹ãé …ç›®**: 
- **éšœå®³æ™‚ã®å¯¾å¿œæ‰‹é †**: 

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

Phase 3å®Œäº†å¾Œã¯ã€[Phase 4: AWS-Fullæ§‹æˆä½“é¨“](phase4-aws-full.md)ã«é€²ã¿ã¾ã™ã€‚

### ç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```bash
# ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤ï¼ˆé‡è¦ï¼šèª²é‡‘åœæ­¢ï¼‰
cd infrastructure/aws-hybrid
terraform destroy

# ç¢ºèª
aws ecs list-clusters
aws rds describe-db-instances
```

---

**é‡è¦**: ã“ã®ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯å®Ÿéš›ã«AWSæ–™é‡‘ãŒç™ºç”Ÿã—ã¾ã™ã€‚ä¸è¦ãªãƒªã‚½ãƒ¼ã‚¹ã¯å¿…ãšå‰Šé™¤ã—ã¦ãã ã•ã„ã€‚ 